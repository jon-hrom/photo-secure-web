# üì∑ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ —Å –∫–∞–º–µ—Ä—ã –≤ –§–æ—Ç–æ –±–∞–Ω–∫

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω –¥–æ—Å—Ç—É–ø –¥–ª—è –∞–¥–º–∏–Ω–æ–≤** 
- –£–ø—Ä–æ—Å—Ç–∏–ª –ø—Ä–æ–≤–µ—Ä–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ `/photo-bank`
- –¢–µ–ø–µ—Ä—å –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å "–ú–æ–π —Ñ–æ—Ç–æ –±–∞–Ω–∫" —Å–æ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- –£–±—Ä–∞–ª —Å—Ç—Ä–æ–≥–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ `isAuthenticated` - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ `userId`
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ Google-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### 2. **–î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å –∫–∞–º–µ—Ä—ã"**
- –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∞ —Ä—è–¥–æ–º —Å –∫–Ω–æ–ø–∫–æ–π "–ö–æ—Ä–∑–∏–Ω–∞"
- –ó–µ–ª—ë–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è
- –ò–∫–æ–Ω–∫–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è —É–∑–Ω–∞–≤–∞–µ–º–æ—Å—Ç–∏

### 3. **–î–∏–∞–ª–æ–≥ –∑–∞–≥—Ä—É–∑–∫–∏ —Å –∫–∞–º–µ—Ä—ã**
–ö–æ–º–ø–æ–Ω–µ–Ω—Ç: `src/components/photobank/CameraUploadDialog.tsx`

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ —Å –¥–∞—Ç–æ–π/–≤—Ä–µ–º–µ–Ω–µ–º
- ‚úÖ –í—ã–±–æ—Ä –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ —Å—Ä–∞–∑—É
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ RAW —Ñ–æ—Ä–º–∞—Ç–æ–≤ (CR2, NEF, ARW, DNG)
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ 3 —Ñ–∞–π–ª–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞
- ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: —É—Å–ø–µ—à–Ω–æ / –æ—à–∏–±–∫–∏ / –æ–∂–∏–¥–∞—é—Ç
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã –∑–∞–≥—Ä—É–∑–∫–∏

### 4. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π**
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç backend `mobile-upload` –¥–ª—è pre-signed URL
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é –≤ S3 (Yandex Object Storage)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –ø–∞–ø–∫—É –≤ –§–æ—Ç–æ –±–∞–Ω–∫–µ
- –î–æ–±–∞–≤–ª—è–µ—Ç —Ñ–æ—Ç–æ –≤ —Å–æ–∑–¥–∞–Ω–Ω—É—é –ø–∞–ø–∫—É
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏

---

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

```
1. –§–æ—Ç–æ–≥—Ä–∞—Ñ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç "–ú–æ–π —Ñ–æ—Ç–æ –±–∞–Ω–∫"
2. –ù–∞–∂–∏–º–∞–µ—Ç "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å –∫–∞–º–µ—Ä—ã"
3. –í–≤–æ–¥–∏—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è)
4. –í—ã–±–∏—Ä–∞–µ—Ç —Ñ–∞–π–ª—ã —Å –∫–∞—Ä—Ç—ã/–∫–∞–º–µ—Ä—ã
5. –ù–∞–∂–∏–º–∞–µ—Ç "–ó–∞–≥—Ä—É–∑–∏—Ç—å"

Backend –ø—Ä–æ—Ü–µ—Å—Å:
- –ü–æ–ª—É—á–∞–µ—Ç pre-signed URL –æ—Ç mobile-upload API
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é –≤ S3 (–ø—É—Ç—å: uploads/{user_id}/{timestamp}_{random}.{ext})
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ uploads)
- –°–æ–∑–¥–∞—ë—Ç –ø–∞–ø–∫—É –≤ –§–æ—Ç–æ –±–∞–Ω–∫–µ
- –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ –≤ –ø–∞–ø–∫—É
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

### Frontend
```
src/components/photobank/
‚îú‚îÄ‚îÄ CameraUploadDialog.tsx          # –ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏
‚îú‚îÄ‚îÄ PhotoBankHeader.tsx             # –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å –∫–∞–º–µ—Ä—ã"
‚îî‚îÄ‚îÄ ...

src/pages/
‚îî‚îÄ‚îÄ PhotoBank.tsx                   # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–∏–∞–ª–æ–≥–∞, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
```

### Backend (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
```
backend/mobile-upload/
‚îú‚îÄ‚îÄ index.py                        # API –¥–ª—è pre-signed URL –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
‚îî‚îÄ‚îÄ tests.json                      # –¢–µ—Å—Ç—ã (‚úÖ 2/2 passed)
```

---

## üéØ API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### Mobile Upload API
`https://functions.poehali.dev/3372b3ed-5509-41e0-a542-b3774be6b702`

**GET ?action=get-url**
```http
Headers: X-User-Id: {userId}
Query: filename, contentType

Response:
{
  "url": "https://storage.yandexcloud.net/...",
  "key": "uploads/{user_id}/{timestamp}_{random}.{ext}",
  "expires_in": 900
}
```

**POST ?action=confirm**
```http
Headers: X-User-Id: {userId}
Body: {
  "action": "confirm",
  "s3_key": "uploads/...",
  "orig_filename": "photo.jpg",
  "size_bytes": 1024000,
  "content_type": "image/jpeg"
}
```

### Photobank Folders API
`https://functions.poehali.dev/6ebe8c65-0cda-4cbf-a49e-f9beb7e5da5a`

**POST ?action=create_folder**
```http
Headers: X-User-Id: {userId}
Body: { "action": "create_folder", "folder_name": "–ó–∞–≥—Ä—É–∑–∫–∞..." }

Response: { "folder": { "id": 42, ... } }
```

**POST ?action=upload_photo**
```http
Headers: X-User-Id: {userId}
Body: {
  "action": "upload_photo",
  "folder_id": 42,
  "file_name": "photo.jpg",
  "s3_url": "https://storage.yandexcloud.net/foto-mix/uploads/...",
  "file_size": 1024000
}
```

---

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `uploads` (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è)
–•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö:
```sql
SELECT * FROM t_p28211681_photo_secure_web.uploads
WHERE user_id = 12
ORDER BY uploaded_at DESC;
```

### –¢–∞–±–ª–∏—Ü–∞ `photobank_folders` (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è)
–ü–∞–ø–∫–∏ —Ñ–æ—Ç–æ –±–∞–Ω–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –¢–∞–±–ª–∏—Ü–∞ `photobank_photos` (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è)
–§–æ—Ç–æ –≤ –ø–∞–ø–∫–∞—Ö —Ñ–æ—Ç–æ –±–∞–Ω–∫–∞

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ Pre-signed URL –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω 15 –º–∏–Ω—É—Ç
- ‚úÖ –¢—Ä–µ–±—É–µ—Ç—Å—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (X-User-Id)
- ‚úÖ –§–∞–π–ª—ã –ø—Ä–∏–≤–∞—Ç–Ω—ã –≤ S3
- ‚úÖ Bucket: `foto-mix` (Yandex Object Storage)
- ‚úÖ –ö–ª—é—á–∏: `YC_S3_KEY_ID` –∏ `YC_S3_SECRET`

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

**–ó–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```sql
SELECT 
  id, orig_filename, size_bytes, 
  status, uploaded_at 
FROM t_p28211681_photo_secure_web.uploads 
WHERE user_id = 12 
ORDER BY uploaded_at DESC 
LIMIT 20;
```

**–ü–∞–ø–∫–∏ –∏ —Ñ–æ—Ç–æ:**
```sql
-- –ü–∞–ø–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT * FROM t_p28211681_photo_secure_web.photobank_folders
WHERE user_id = 12 ORDER BY created_at DESC;

-- –§–æ—Ç–æ –≤ –ø–∞–ø–∫–µ
SELECT * FROM t_p28211681_photo_secure_web.photobank_photos
WHERE folder_id = 42 ORDER BY created_at DESC;
```

---

## üéâ –ì–æ—Ç–æ–≤–æ!

–¢–µ–ø–µ—Ä—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ã –º–æ–≥—É—Ç:
1. **–ó–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–æ—Ç–æ –ø—Ä—è–º–æ —Å –∫–∞–º–µ—Ä—ã** —á–µ—Ä–µ–∑ —Ç–µ–ª–µ—Ñ–æ–Ω/–ø–ª–∞–Ω—à–µ—Ç
2. **–§–∞–π–ª—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è** –≤ –ø–∞–ø–∫—É –≤ –§–æ—Ç–æ –±–∞–Ω–∫–µ
3. **–†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö** (–º–æ–±–∏–ª—å–Ω—ã–µ, –ø–ª–∞–Ω—à–µ—Ç—ã, –¥–µ—Å–∫—Ç–æ–ø—ã)
4. **–ê–¥–º–∏–Ω—ã –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø** –∫ –§–æ—Ç–æ –±–∞–Ω–∫—É

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚ö° **–ë—ã—Å—Ç—Ä–æ** - –ø—Ä—è–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤ S3
- üîí **–ë–µ–∑–æ–ø–∞—Å–Ω–æ** - pre-signed URL —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º
- üì± **–£–¥–æ–±–Ω–æ** - —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- üìÅ **–û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–Ω–æ** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–æ–∫
- üíæ **–≠–∫–æ–Ω–æ–º–∏—Ç —Ç—Ä–∞—Ñ—Ñ–∏–∫** - –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ backend

### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- [ ] –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–æ—Ç–æ
- [ ] –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ EXIF –¥–∞–Ω–Ω—ã—Ö
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Å—ä—ë–º–∫–∏
- [ ] –ü–∞–∫–µ—Ç–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
