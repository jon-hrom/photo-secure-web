# Настройка VK ID авторизации

## Шаг 1: Создание приложения VK

1. Перейдите на https://dev.vk.com/ru/apps
2. Войдите в аккаунт VK
3. Нажмите **"Создать приложение"**
4. Заполните форму:
   - **Название:** Foto-Mix (или ваше название)
   - **Тип:** Standalone-приложение
   - **Категория:** Фото
5. Нажмите **"Создать"**

## Шаг 2: Получение Client ID и Secret

После создания приложения:

1. В разделе **"Настройки"** найдите:
   - **ID приложения** (VK_CLIENT_ID) — например: `54323080`
   - **Защищённый ключ** (VK_CLIENT_SECRET) — например: `SeLz3kneak8ZqUFK6X7o`

2. Скопируйте эти значения — они понадобятся для настройки

## Шаг 3: Настройка Redirect URI

1. В разделе **"Настройки"** найдите **"Authorized redirect URIs"**
2. Добавьте URL вашего сайта:
   ```
   https://foto-mix.ru/auth/callback/vkid
   ```
3. Если используете локальную разработку, добавьте также:
   ```
   http://localhost:5173/auth/callback/vkid
   ```
4. Нажмите **"Сохранить"**

## Шаг 4: Настройка прав доступа

1. В разделе **"Настройки"** → **"Права доступа"**
2. Включите следующие разрешения:
   - ✅ **Email** — доступ к email пользователя
   - ✅ **Phone** — доступ к номеру телефона (опционально)
   - ✅ **Offline access** — возможность обновлять токен

## Шаг 5: Добавление секретов в poehali.dev

В интерфейсе poehali.dev добавьте три секрета:

### 1. VK_CLIENT_ID
```
54323080
```
(ваш ID приложения из шага 2)

### 2. VK_CLIENT_SECRET
```
SeLz3kneak8ZqUFK6X7o
```
(ваш защищённый ключ из шага 2)

### 3. BASE_URL
```
https://foto-mix.ru
```
(адрес вашего основного домена без слеша на конце)

⚠️ **Важно:** BASE_URL должен совпадать с доменом в Redirect URI!

## Шаг 6: Тестирование

1. Откройте ваш сайт
2. Нажмите кнопку **"Войти через VK"**
3. Разрешите доступ к данным VK
4. После успешного входа вы будете перенаправлены на главную страницу
5. Данные пользователя сохранятся в базе данных

## Безопасность

✅ Реализованные меры защиты:

- **PKCE** — защита от перехвата authorization code
- **State** — защита от CSRF атак
- **Nonce** — защита от replay атак
- **HTTPS Only** — все данные передаются по защищённому соединению
- **Server-side validation** — все токены проверяются на сервере
- **Auto session cleanup** — старые сессии автоматически удаляются

## Структура базы данных

После входа создаётся запись в таблице `vk_users`:

```sql
user_id          - уникальный ID пользователя в БД
vk_sub           - VK user ID
email            - email пользователя
phone_number     - телефон (если предоставлен)
full_name        - имя пользователя
avatar_url       - ссылка на аватар
is_verified      - верифицирован ли аккаунт VK
raw_profile      - полный профиль VK (JSON)
registered_at    - дата первого входа
last_login       - дата последнего входа
```

## Troubleshooting

### Ошибка "VK credentials not configured"
- Проверьте, что все 3 секрета добавлены в poehali.dev
- Перезапустите backend функцию

### Ошибка "Invalid redirect_uri"
- Убедитесь, что BASE_URL совпадает с настройками в VK приложении
- Проверьте, что URL указан БЕЗ слеша на конце

### Ошибка "Invalid state"
- Очистите cookies браузера
- Попробуйте войти снова с новой сессии

### Пользователь не сохраняется в БД
- Проверьте, что секрет DATABASE_URL добавлен
- Посмотрите логи backend функции vk-auth

## Дополнительная информация

- Документация VK ID: https://dev.vk.com/ru/vk-id/overview
- OpenID Connect спецификация: https://openid.net/specs/openid-connect-core-1_0.html
- Поддержка: https://t.me/+QgiLIa1gFRY4Y2Iy
