# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Yandex Cloud Object Storage –¥–ª—è foto-mix

## 1. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ Yandex Cloud

### –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ foto-mix
```bash
yc iam service-account get foto-mix --format json | grep "^id"
```
–ò–ª–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏: **IAM ‚Üí –°–µ—Ä–≤–∏—Å–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã ‚Üí foto-mix ‚Üí ID**

–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ `<SERVICE_ACCOUNT_ID_foto-mix>`

---

### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –±–∞–∫–µ—Ç–∞

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Object Storage ‚Üí –ë–∞–∫–µ—Ç—ã ‚Üí –°–æ–∑–¥–∞—Ç—å –±–∞–∫–µ—Ç**
2. –ò–º—è –±–∞–∫–µ—Ç–∞: `foto-mix`
3. –†–µ–≥–∏–æ–Ω: `ru-central1`
4. **–î–æ—Å—Ç—É–ø –Ω–∞ —á—Ç–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤**: `–ó–∞–∫—Ä—ã—Ç—ã–π` (–° –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π)
5. **–î–æ—Å—Ç—É–ø –∫ —Å–ø–∏—Å–∫—É –æ–±—ä–µ–∫—Ç–æ–≤**: `–ó–∞–∫—Ä—ã—Ç—ã–π` (–° –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π)
6. **–ö–ª–∞—Å—Å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞**: `–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ`
7. –ù–∞–∂–º–∏—Ç–µ **–°–æ–∑–¥–∞—Ç—å –±–∞–∫–µ—Ç**

---

### –®–∞–≥ 3: –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π —Å–µ—Ä–≤–∏—Å–Ω–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É

1. –û—Ç–∫—Ä–æ–π—Ç–µ –±–∞–∫–µ—Ç `foto-mix`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ ‚Üí ACL –±–∞–∫–µ—Ç–∞ ‚Üí –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ACL**
3. –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∞:
   - **–ü–æ–ª—É—á–∞—Ç–µ–ª—å**: –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç `foto-mix`
   - **–ü—Ä–∞–≤–∞**: `READ` –∏ `WRITE`
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ —á–µ—Ä–µ–∑ CLI:**
```bash
yc resource-manager folder add-access-binding <FOLDER_ID> \
  --service-account-id <SERVICE_ACCOUNT_ID_foto-mix> \
  --role storage.uploader
```

---

### –®–∞–≥ 4: –í–∫–ª—é—á–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

1. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–∞–∫–µ—Ç–∞ `foto-mix`
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ**
3. –í–∫–ª—é—á–∏—Ç–µ **–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤**
4. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ

---

### –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS

1. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–∞–∫–µ—Ç–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **CORS**
2. –ù–∞–∂–º–∏—Ç–µ **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å**
3. –í—Å—Ç–∞–≤—å—Ç–µ JSON –Ω–∏–∂–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ

**CORS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```json
[
  {
    "AllowedOrigins": [
      "https://foto-mix.ru",
      "https://www.foto-mix.ru",
      "http://localhost:3000"
    ],
    "AllowedMethods": [
      "GET",
      "PUT",
      "HEAD",
      "POST"
    ],
    "AllowedHeaders": [
      "Content-Type",
      "Authorization",
      "x-amz-acl",
      "x-amz-meta-user-id",
      "x-amz-meta-*"
    ],
    "ExposeHeaders": [
      "ETag",
      "Location"
    ],
    "MaxAgeSeconds": 3600
  }
]
```

---

### –®–∞–≥ 6: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤–∏–ª –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞

1. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–∞–∫–µ—Ç–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Lifecycle**
2. –ù–∞–∂–º–∏—Ç–µ **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å**
3. –í—Å—Ç–∞–≤—å—Ç–µ JSON –Ω–∏–∂–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ

**Lifecycle –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```json
{
  "Rules": [
    {
      "ID": "cleanup-incoming-90d",
      "Status": "Enabled",
      "Filter": {
        "Prefix": "incoming/"
      },
      "Expiration": {
        "Days": 90
      }
    },
    {
      "ID": "abort-incomplete-mpu-7d",
      "Status": "Enabled",
      "Filter": {},
      "AbortIncompleteMultipartUpload": {
        "DaysAfterInitiation": 7
      }
    }
  ]
}
```

---

### –®–∞–≥ 7: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Bucket Policy (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

1. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–∞–∫–µ—Ç–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Bucket Policy**
2. –ù–∞–∂–º–∏—Ç–µ **–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å**
3. –í—Å—Ç–∞–≤—å—Ç–µ JSON –Ω–∏–∂–µ, **–∑–∞–º–µ–Ω–∏–≤** `<SERVICE_ACCOUNT_ID_foto-mix>` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID

**Bucket Policy:**
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowUploadToIncoming",
      "Effect": "Allow",
      "Principal": {
        "CanonicalUser": "<SERVICE_ACCOUNT_ID_foto-mix>"
      },
      "Action": [
        "s3:PutObject",
        "s3:AbortMultipartUpload"
      ],
      "Resource": [
        "arn:aws:s3:::foto-mix/incoming/*"
      ]
    },
    {
      "Sid": "AllowListIncoming",
      "Effect": "Allow",
      "Principal": {
        "CanonicalUser": "<SERVICE_ACCOUNT_ID_foto-mix>"
      },
      "Action": [
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::foto-mix"
      ],
      "Condition": {
        "StringLike": {
          "s3:prefix": [
            "incoming/*"
          ]
        }
      }
    },
    {
      "Sid": "AllowReadProcessed",
      "Effect": "Allow",
      "Principal": {
        "CanonicalUser": "<SERVICE_ACCOUNT_ID_foto-mix>"
      },
      "Action": [
        "s3:GetObject",
        "s3:HeadObject"
      ],
      "Resource": [
        "arn:aws:s3:::foto-mix/incoming/*",
        "arn:aws:s3:::foto-mix/processed/*"
      ]
    }
  ]
}
```

**‚ö†Ô∏è –í–ê–ñ–ù–û:** –ù–ï –¥–æ–±–∞–≤–ª—è–π—Ç–µ `"Principal": "*"` ‚Äî —ç—Ç–æ —Å–¥–µ–ª–∞–µ—Ç –±–∞–∫–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–º!

---

## 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª—é—á–µ–π –≤ –±–∞–∫–µ—Ç–µ

```
foto-mix/
‚îú‚îÄ‚îÄ incoming/{userId}/{uuid}.{ext}    # –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îî‚îÄ‚îÄ processed/{userId}/{uuid}.{ext}   # –û–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
```

**–ü—Ä–∞–≤–∏–ª–∞ –∏–º–µ–Ω–æ–≤–∞–Ω–∏—è:**
- `{userId}` ‚Äî ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
- `{uuid}` ‚Äî UUID v4 –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
- `{ext}` ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ (jpg, png, heic –∏ —Ç.–¥.)

---

## 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –ß–µ–∫-–ª–∏—Å—Ç

- [ ] –ë–∞–∫–µ—Ç –ù–ï –ø—É–±–ª–∏—á–Ω—ã–π (–¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π)
- [ ] –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–∏ S3 —Ö—Ä–∞–Ω—è—Ç—Å—è –¢–û–õ–¨–ö–û –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (–≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö)
- [ ] Pre-signed URL –≤—ã–¥–∞—é—Ç—Å—è —Å TTL 10-15 –º–∏–Ω—É—Ç
- [ ] –ü–µ—Ä–µ–¥ –≤—ã–¥–∞—á–µ–π GET URL –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–ª–∞–¥–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–º (userId)
- [ ] CORS —Ä–∞–∑—Ä–µ—à—ë–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–º–µ–Ω–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
- [ ] –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ `x-amz-meta-user-id` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- [ ] –ö–≤–æ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –î–û –≤—ã–¥–∞—á–∏ upload URL
- [ ] –ó–∞–ø–∏—Å–∏ –≤ –ë–î —Å–æ–∑–¥–∞—é—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
- [ ] Lifecycle –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã
- [ ] –õ–æ–≥–∏ Object Storage –≤–∫–ª—é—á–µ–Ω—ã –¥–ª—è –∞—É–¥–∏—Ç–∞

---

## 4. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ AWS CLI

```bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è
aws configure --profile yc-foto-mix
# AWS Access Key ID: <YC_S3_KEY_ID>
# AWS Secret Access Key: <YC_S3_SECRET>
# Default region name: ru-central1
# Default output format: json

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
aws s3 ls s3://foto-mix/incoming/ \
  --profile yc-foto-mix \
  --endpoint-url=https://storage.yandexcloud.net

# –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
aws s3 cp test.jpg s3://foto-mix/incoming/test-user/test.jpg \
  --profile yc-foto-mix \
  --endpoint-url=https://storage.yandexcloud.net

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
aws s3api head-object \
  --bucket foto-mix \
  --key incoming/test-user/test.jpg \
  --profile yc-foto-mix \
  --endpoint-url=https://storage.yandexcloud.net
```

---

## 5. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏

1. –í –∫–æ–Ω—Å–æ–ª–∏ Yandex Cloud –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Object Storage ‚Üí foto-mix ‚Üí –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
2. –í–∫–ª—é—á–∏—Ç–µ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   - –°–æ–∑–¥–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–∞–∫–µ—Ç `foto-mix-logs`
   - –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö `foto-mix` —É–∫–∞–∂–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π –±–∞–∫–µ—Ç –¥–ª—è –ª–æ–≥–æ–≤

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –Ω–∞ –±—ç–∫–µ–Ω–¥–µ (YC_S3_KEY_ID, YC_S3_SECRET)
2. ‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é –ë–î –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `user_files`
3. ‚úÖ –†–∞–∑–≤–µ—Ä–Ω–∏—Ç–µ –±—ç–∫–µ–Ω–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å S3
4. ‚úÖ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ UI
5. üîÑ –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Ç—Ä–∏–≥–≥–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ —á–µ—Ä–µ–∑ Message Queue (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
