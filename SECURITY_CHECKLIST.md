# –ß–µ–∫-–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ S3 –∑–∞–≥—Ä—É–∑–∫–∏

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞
- [x] –ë–∞–∫–µ—Ç `foto-mix` —Å–æ–∑–¥–∞–Ω –∫–∞–∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π (–ù–ï –ø—É–±–ª–∏—á–Ω—ã–π)
- [x] –î–æ—Å—Ç—É–ø –∫ –æ–±—ä–µ–∫—Ç–∞–º —Ç–æ–ª—å–∫–æ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
- [x] CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–º–µ–Ω–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
- [x] Lifecycle –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –∞–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∏ (90 –¥–Ω–µ–π)
- [x] –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö multipart (7 –¥–Ω–µ–π)
- [x] –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ

### –ë—ç–∫–µ–Ω–¥
- [x] S3 –∫–ª—é—á–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö (–Ω–µ –≤ –∫–æ–¥–µ)
- [x] Pre-signed URL –≤—ã–¥–∞—é—Ç—Å—è —Å TTL 10-15 –º–∏–Ω—É—Ç
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç—ã –ü–ï–†–ï–î –≤—ã–¥–∞—á–µ–π upload URL
- [x] –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è —Ñ–∞–π–ª–æ–º –ø–µ—Ä–µ–¥ –≤—ã–¥–∞—á–µ–π download URL
- [x] –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ `x-amz-meta-user-id` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- [x] –ó–∞–ø–∏—Å–∏ –≤ –ë–î —Å–æ–∑–¥–∞—é—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
- [x] HeadObject –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
- [x] Unique constraint –Ω–∞ `s3_key` –≤ –ë–î

### API
- [x] OPTIONS handler –¥–ª—è CORS –Ω–∞ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
- [x] –í–∞–ª–∏–¥–∞—Ü–∏—è `userId` –ø–µ—Ä–µ–¥ –ª—é–±–æ–π –æ–ø–µ—Ä–∞—Ü–∏–µ–π
- [x] HTTP 403 –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –∫–≤–æ—Ç—ã
- [x] HTTP 403 –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–∫–∞—á–∞—Ç—å —á—É–∂–æ–π —Ñ–∞–π–ª
- [x] HTTP 404 –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- [x] –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã

---

## ‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### Yandex Cloud Console

#### 1. –ü–æ–ª—É—á–∏—Ç—å ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
```bash
yc iam service-account get foto-mix --format json | grep "^id"
```
–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ `<SERVICE_ACCOUNT_ID_foto-mix>`

#### 2. –°–æ–∑–¥–∞—Ç—å –±–∞–∫–µ—Ç `foto-mix`
- –†–µ–≥–∏–æ–Ω: `ru-central1`
- –î–æ—Å—Ç—É–ø: **–ó–∞–∫—Ä—ã—Ç—ã–π** (–æ–±–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞)
- –ö–ª–∞—Å—Å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ

#### 3. –ù–∞–∑–Ω–∞—á–∏—Ç—å –ø—Ä–∞–≤–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É
- –û—Ç–∫—Ä—ã—Ç—å –±–∞–∫–µ—Ç ‚Üí –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ ‚Üí ACL –±–∞–∫–µ—Ç–∞
- –î–æ–±–∞–≤–∏—Ç—å `foto-mix` —Å –ø—Ä–∞–≤–∞–º–∏ `READ` –∏ `WRITE`

#### 4. –í–∫–ª—é—á–∏—Ç—å –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∫–µ—Ç–∞ ‚Üí –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí –í–∫–ª—é—á–∏—Ç—å

#### 5. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS
–í—Å—Ç–∞–≤–∏—Ç—å JSON –∏–∑ `YANDEX_CLOUD_SETUP.md` —Ä–∞–∑–¥–µ–ª "CORS –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"

#### 6. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Lifecycle
–í—Å—Ç–∞–≤–∏—Ç—å JSON –∏–∑ `YANDEX_CLOUD_SETUP.md` —Ä–∞–∑–¥–µ–ª "Lifecycle –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è"

#### 7. –ü—Ä–∏–º–µ–Ω–∏—Ç—å Bucket Policy (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
–í—Å—Ç–∞–≤–∏—Ç—å JSON –∏–∑ `YANDEX_CLOUD_SETUP.md` —Ä–∞–∑–¥–µ–ª "Bucket Policy"  
**‚ö†Ô∏è –ó–∞–º–µ–Ω–∏—Ç—å `<SERVICE_ACCOUNT_ID_foto-mix>` –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID!**

#### 8. –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ –ø—Ä–æ–µ–∫—Ç
- `YC_S3_KEY_ID` ‚Äî Access Key ID —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
- `YC_S3_SECRET` ‚Äî Secret Access Key —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞

---

## üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### –¢–µ—Å—Ç 1: –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–∞—á–∞—Ç—å —á—É–∂–æ–π —Ñ–∞–π–ª
```javascript
const s3Key = 'incoming/1/some-file.jpg';
const attackerUserId = 999;

fetch(`https://functions.poehali.dev/8a60ca41-e494-417e-b881-2ce4f1f4247e?key=${s3Key}&userId=${attackerUserId}`)
  .then(r => r.json())
  .then(data => console.log(data));
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `{"error": "Access denied. You do not own this file."}` (403)

---

### –¢–µ—Å—Ç 2: –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–µ–≤—ã—Å–∏—Ç—å –∫–≤–æ—Ç—É
```javascript
const userId = 1;

fetch('https://functions.poehali.dev/85f5163d-cdb4-42ad-96df-ace30518b059', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    userId,
    contentType: 'image/jpeg',
    ext: 'jpg',
    plannedSize: 6 * 1024 * 1024 * 1024
  })
})
  .then(r => r.json())
  .then(data => console.log(data));
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `{"error": "Quota exceeded. Available: X bytes"}` (403)

---

### –¢–µ—Å—Ç 3: –ë–∞–∫–µ—Ç –ù–ï –ø—É–±–ª–∏—á–Ω—ã–π
```bash
curl https://storage.yandexcloud.net/foto-mix/incoming/1/test.jpg
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `AccessDenied` (403 XML)

---

### –¢–µ—Å—Ç 4: CORS —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–≤–æ–∏—Ö –¥–æ–º–µ–Ω–æ–≤
```javascript
fetch('https://storage.yandexcloud.net/foto-mix/incoming/1/test.jpg', {
  method: 'GET',
  headers: { 'Origin': 'https://evil-site.com' }
})
  .catch(error => console.log('CORS blocked:', error));
```
**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å (CORS error)

---

### –¢–µ—Å—Ç 5: Pre-signed URL –∏—Å—Ç–µ–∫–∞–µ—Ç
1. –ü–æ–ª—É—á–∏—Ç—å upload URL
2. –ü–æ–¥–æ–∂–¥–∞—Ç—å 16 –º–∏–Ω—É—Ç
3. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** `AccessDenied` –∏–ª–∏ `RequestTimeTooSkewed`

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏ Object Storage
1. –ö–æ–Ω—Å–æ–ª—å Yandex Cloud ‚Üí Object Storage ‚Üí foto-mix
2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ ‚Üí –í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
3. –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–∞–∫–µ—Ç `foto-mix-logs`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
```sql
SELECT 
  owner_user_id,
  COUNT(*) as files_count,
  SUM(size_bytes) as used_bytes,
  ROUND(SUM(size_bytes) / (1024.0 * 1024.0 * 1024.0), 2) as used_gb
FROM user_files
WHERE status IN ('uploaded', 'processing', 'processed')
GROUP BY owner_user_id
ORDER BY used_bytes DESC;
```

### –§–∞–π–ª—ã –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
```sql
SELECT 
  status, 
  COUNT(*) as count,
  SUM(size_bytes) as total_bytes
FROM user_files
GROUP BY status;
```

---

## üö® –ß—Ç–æ –ù–ò–ö–û–ì–î–ê –Ω–µ –¥–µ–ª–∞—Ç—å

1. **–ù–ï –¥–µ–ª–∞—Ç—å –±–∞–∫–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–º** ‚Äî —ç—Ç–æ –æ—Ç–∫—Ä–æ–µ—Ç –¥–æ—Å—Ç—É–ø –≤—Å–µ–º
2. **–ù–ï —Ö—Ä–∞–Ω–∏—Ç—å S3 –∫–ª—é—á–∏ –≤ –∫–æ–¥–µ** ‚Äî —Ç–æ–ª—å–∫–æ –≤ —Å–µ–∫—Ä–µ—Ç–∞—Ö
3. **–ù–ï –≤—ã–¥–∞–≤–∞—Ç—å download URL –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–Ω–∏—è** ‚Äî —É—Ç–µ—á–∫–∞ –¥–∞–Ω–Ω—ã—Ö
4. **–ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å TTL > 1 —á–∞—Å–∞** –¥–ª—è pre-signed URL
5. **–ù–ï –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å S3 –∫–ª—é—á–∏ –∏–ª–∏ pre-signed URL** ‚Äî –æ–Ω–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–¥–ø–∏—Å—å
6. **–ù–ï –¥–æ–±–∞–≤–ª—è—Ç—å `"Principal": "*"` –≤ Bucket Policy** ‚Äî —ç—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø
7. **–ù–ï –æ—Ç–¥–∞–≤–∞—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ S3 –∫–ª—é—á–∏** ‚Äî —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –±—ç–∫–µ–Ω–¥
8. **–ù–ï –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–≤–æ—Ç—ã** ‚Äî –º–æ–∂–Ω–æ –∏—Å—á–µ—Ä–ø–∞—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

---

## ‚úÖ –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞

–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –≤ –ø—Ä–æ–¥–∞–∫—à–Ω —É–±–µ–¥–∏—Ç–µ—Å—å:

- [ ] –ë–∞–∫–µ—Ç `foto-mix` —Å–æ–∑–¥–∞–Ω –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π
- [ ] –°–µ—Ä–≤–∏—Å–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç `foto-mix` –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –Ω–∞ –±–∞–∫–µ—Ç
- [ ] CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∞—à–∏—Ö –¥–æ–º–µ–Ω–æ–≤
- [ ] Lifecycle –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- [ ] –°–µ–∫—Ä–µ—Ç—ã `YC_S3_KEY_ID` –∏ `YC_S3_SECRET` –¥–æ–±–∞–≤–ª–µ–Ω—ã
- [ ] –í—Å–µ 4 —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–¥–µ–ø–ª–æ–µ–Ω—ã (100% —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ)
- [ ] –¢–∞–±–ª–∏—Ü–∞ `user_files` —Å–æ–∑–¥–∞–Ω–∞ –≤ –ë–î
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π: –∑–∞–≥—Ä—É–∑–∫–∞ ‚Üí –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ —Å–∫–∞—á–∞—Ç—å —á—É–∂–æ–π —Ñ–∞–π–ª (–¥–æ–ª–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è)
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –∫–≤–æ—Ç—ã (–¥–æ–ª–∂–Ω–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å—Å—è)
- [ ] Pre-signed URL –∏—Å—Ç–µ–∫–∞—é—Ç —á–µ—Ä–µ–∑ 10-15 –º–∏–Ω—É—Ç

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Ñ—É–Ω–∫—Ü–∏–π –≤ –∫–æ–Ω—Å–æ–ª–∏ Cloud Functions
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ —Å–µ—Ä–≤–∏—Å–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–∞ –±–∞–∫–µ—Ç
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Å–µ–∫—Ä–µ—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –ø—Ä–æ–µ–∫—Ç
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (—Å–º. `S3_UPLOAD_EXAMPLES.md`)
