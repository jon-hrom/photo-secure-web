# Загрузка видео по URL

API для загрузки видео из различных источников в фотобанк.

## Поддерживаемые форматы

1. **Прямые ссылки на видео**: `.mp4`, `.mov`, `.avi`, `.mkv`, `.webm`
2. **HLS потоки**: `.m3u8` плейлисты (Kinescope, собственные стримы)
3. **Kinescope**: Автоматическое извлечение m3u8 со страницы

## Как использовать

### Для Kinescope:

1. Откройте страницу с видео в браузере
2. Откройте DevTools (F12) → вкладка **Network**
3. Начните воспроизведение видео
4. Найдите запрос к файлу `.m3u8` (фильтр: XHR или Media)
5. Скопируйте полный URL (ПКМ → Copy → Copy link address)
6. Вставьте в форму загрузки

Пример URL:
```
https://kinescope.io/xxxxxxxxx/master.m3u8?token=yyyyyyy
```

### Для других источников:

- **Прямая ссылка**: просто вставьте URL на видеофайл
- **HLS поток**: вставьте ссылку на `.m3u8` плейлист

## Ограничения

- **DRM-защищенные видео**: невозможно скачать (Widevine, PlayReady, FairPlay)
- **Размер файла**: ограничен временем выполнения Cloud Function (макс. 3 минуты)
- **HLS сегменты**: загружается до 100 сегментов (~5 минут видео)

## Технические детали

### Архитектура скачивания:

1. **Определение типа источника**:
   - Прямая ссылка → скачивание через `requests`
   - `.m3u8` URL → парсинг плейлиста через `m3u8` библиотеку
   - Kinescope страница → извлечение m3u8 через regex

2. **Обработка HLS**:
   - Загрузка master плейлиста
   - Выбор лучшего качества (первый вариант)
   - Загрузка всех .ts сегментов
   - Склейка в один .mp4 файл

3. **Загрузка в S3**:
   - Сохранение в бакет `files`
   - Формирование CDN URL
   - Запись метаданных в БД (is_video=true)

### API

**Endpoint**: `POST /video-url-upload`

**Headers**:
```json
{
  "Content-Type": "application/json",
  "X-User-Id": "123"
}
```

**Body**:
```json
{
  "url": "https://example.com/video.mp4",
  "folder_id": 456,
  "headers": {
    "Cookie": "session=abc123"
  }
}
```

**Response (успех)**:
```json
{
  "success": true,
  "video_id": 789,
  "filename": "video_1234567890.mp4",
  "size": 15728640,
  "s3_url": "https://cdn.poehali.dev/projects/xxx/bucket/videos/123/...",
  "folder_id": 456
}
```

**Response (ошибка)**:
```json
{
  "error": "Видео защищено DRM - скачивание невозможно",
  "details": "Technical error message"
}
```

## Зависимости

- `m3u8==3.5.0` - парсинг HLS плейлистов
- `requests` - HTTP запросы
- `boto3` - загрузка в S3
- `psycopg2` - работа с PostgreSQL

## Troubleshooting

### Ошибка "DRM protection"
Видео защищено и не может быть скачано. Попробуйте найти альтернативный источник.

### Ошибка "403 Forbidden"
Требуется авторизация. Скопируйте cookies из браузера и передайте в поле `headers`.

### Ошибка "Timeout"
Видео слишком большое или медленное соединение. Попробуйте скачать локально и загрузить напрямую.

### Плейлист пуст
Неверная ссылка на .m3u8 или плейлист защищен токеном с истекшим сроком.
